# Habit Tracker API

## О проекте

Habit Tracker — это бэкенд-часть SPA веб-приложения для трекера полезных привычек, вдохновленного книгой Джеймса Клира "Атомные привычки". Сервис позволяет пользователям создавать, отслеживать и получать напоминания о своих привычках через Telegram.

## Возможности

- Регистрация и аутентификация пользователей  
- CRUD операции с привычками  
- Валидация привычек по бизнес-правилам  
- Пагинация списка привычек  
- Публичные привычки для общего доступа  
- Интеграция с Telegram для напоминаний  
- Отложенные задачи через Celery  
- Автоматическая документация API

## Модели данных

### Пользователь (User)

- **Username** - уникальное имя пользователя (используется для входа)  
- **Email** - уникальный email адрес (обязательный при регистрации)  
- **Телефон** - опционально  
- **Аватар** - опционально, загружается в `avatars/`  
- **Telegram Chat ID** - для отправки уведомлений в Telegram

### Привычка (Habits)
- **Пользователь** - создатель привычки  
- **Место** - место выполнения  
- **Время** - время выполнения (формат HH:MM)  
- **Действие** - описание привычки  
- **Признак приятной привычки** - булево поле  
- **Связанная привычка** - приятная привычка для вознаграждения  
- **Периодичность** - дни между выполнениями (1-7)  
- **Вознаграждение** - текстовое описание награды  
- **Время на выполнение** - секунды (≤120)  
- **Признак публичности** - доступность другим пользователям

## Валидаторы

1. **Взаимоисключение**: нельзя одновременно указывать связанную привычку и вознаграждение  
2. **Время выполнения**: не более 120 секунд  
3. **Связанные привычки**: только приятные привычки  
4. **Приятные привычки**: не могут иметь вознаграждения или связанных привычек  
5. **Периодичность**: не реже 1 раза в 7 дней  

## Права доступа

- **Аутентифицированные пользователи**: полный CRUD для своих привычек  
- **Гости**: только просмотр публичных привычек  
- **Владельцы привычек**: полный доступ к своим данным  

## API Endpoints

### Аутентификация (без авторизации)
- `POST /api/token/` - Получение JWT токена  
- `POST /api/token/refresh/` - Обновление JWT токена  
- `POST /api/registr/` - Регистрация нового пользователя  

### Пользователи
- `GET /api/users/` - Список пользователей (требуется авторизация)  
- `GET /api/users/{id}/` - Детали пользователя (требуется авторизация)  

### Привычки (требуется авторизация)
- `GET /api/habits/` - Список привычек пользователя  
- `POST /api/habits/create/` - Создание новой привычки  
- `GET /api/habits/{id}/` - Детали привычки  
- `PUT /api/habits/{id}/update/` - Обновление привычки  
- `DELETE /api/habits/{id}/delete/` - Удаление привычки  

### Публичные привычки (доступно без авторизации)
- `GET /api/published-habits/` - Список публичных привычек  

## Telegram Интеграция

### Напоминания
- Автоматическая отправка в указанное время привычки  
- Формат: "Мне нужно [ДЕЙСТВИЕ] в [ВРЕМЯ] в [МЕСТО]"  
- Периодичность согласно настройкам привычки  

## Установка и запуск

### 1. Клонирование репозитория
```
git clone <repository-url>
cd habit_tracker
```

## Использование на удалённом сервере с docker-compose
### Настройка сервера

1. Откройте терминал и выполните команду для обновления списка пакетов на сервере: ```sudo apt update```
2. Затем выполните команду для обновления всех установленных пакетов до их последних версий: ```sudo apt upgrade```
3. Установите [Docker](https://docs.docker.com/engine/install/ubuntu/#install-using-the-repository)
4. Проверьте состояние файрвола с помощью команды: ```sudo ufw status``` и если фаервол отключен, активируйте его: ```sudo ufw enable```
5. Откройте необходимые порты: ```sudo ufw allow 80/tcp``` ```sudo ufw allow 443/tcp``` ```sudo ufw allow 22/tcp```

### Установка Git
1. Откройте терминал на сервере и выполните команду: ```sudo apt update``` ```sudo apt install git```
2. Клонируйте репозиторий:
```
git clone git@github.com:kveremyeva/habit_tracker.git
```

### Запуск
1. Перейдите в директорию, где находится файл docker-compose.yml: ```cd /your/path/hht```
2. Создайте файл .env и внесите необходимые переменные окружения на примере '.env.smple': ```nano .env```
3. Запустите проект командой: ```docker-compose up -d```

## Использование проекта с автоматическим деплоем
### Настройка сервера

1. Откройте терминал и выполните команду для обновления списка пакетов на сервере: ```sudo apt update```
2. Затем выполните команду для обновления всех установленных пакетов до их последних версий: ```sudo apt upgrade```
3. Установите [Docker](https://docs.docker.com/engine/install/ubuntu/#install-using-the-repository)
4. Проверьте состояние файрвола с помощью команды: ```sudo ufw status``` и если фаервол отключен, активируйте его: ```sudo ufw enable```
5. Откройте необходимые порты: ```sudo ufw allow 80/tcp``` ```sudo ufw allow 443/tcp``` ```sudo ufw allow 22/tcp```


### Деплой
В проекте настроен файл GitHub Actions workflow(.github/workflows/ci.yml).
Благодаря этому при каждом push проекта запускается линтер flake8, запускаются тесты и проект деплоится на удалённый сервер после успешного прохождения тестов.
Для корректной работы необходимо настроить секреты в вашем репозитории в GitHub.
1. Создайте секреты:
```
DATABASE_HOST,
DEPLOY_DIR,
DOCKER_HUB_ACCESS_TOKEN,
DOCKER_HUB_USERNAME,
POSTGRES_DB,
POSTGRES_PASSWORD,
POSTGRES_USER,
SECRET_KEY,
SERVER_IP,
SSH_KEY,
SSH_USER,
TG_TOKEN
```
2. В сервисах 'web', 'celery', 'celery-beat' в строке image укажите свой DOCKER_HUB_USERNAME